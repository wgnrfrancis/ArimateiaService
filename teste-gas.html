<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Google Apps Script - Balc√£o da Cidadania</title>
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>
    <div class="container" style="max-width: 800px; margin: 50px auto; padding: 20px;">
        <h1>üîó Teste de Conex√£o - Google Apps Script</h1>
        
        <div class="card">
            <h2>üì° Status da Configura√ß√£o:</h2>
            <div id="config-status">
                <p>Carregando...</p>
            </div>
        </div>

        <div class="card">
            <h2>üß™ Teste de Conex√£o:</h2>
            <button onclick="testConnection()" class="btn btn-primary">Testar Conex√£o</button>
            <div id="connection-result" style="margin-top: 20px;">
                <!-- Resultado aparecer√° aqui -->
            </div>
        </div>

        <div class="card">
            <h2>üîê Teste de Login:</h2>
            <div class="form-group">
                <input type="email" id="test-email" placeholder="Email" class="form-input" value="secretaria@arimateia.org.br">
            </div>
            <div class="form-group">
                <input type="password" id="test-password" placeholder="Senha" class="form-input" value="123456">
            </div>
            <button onclick="testLogin()" class="btn btn-secondary">Testar Login</button>
            <div id="login-result" style="margin-top: 20px;">
                <!-- Resultado aparecer√° aqui -->
            </div>
        </div>

        <div class="card">
            <h2>üìã Teste de Cria√ß√£o de Chamado:</h2>
            <button onclick="testCreateTicket()" class="btn btn-success">Criar Chamado de Teste</button>
            <div id="ticket-result" style="margin-top: 20px;">
                <!-- Resultado aparecer√° aqui -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="data/config.js"></script>
    <script src="scripts/helpers.js"></script>
    <script src="scripts/flow.js"></script>
    <script src="scripts/auth.js"></script>

    <script>
        let flowManager;
        let authManager;

        // Inicializar quando DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Inicializando teste...');
            checkConfiguration();
            
            try {
                flowManager = new FlowExtensions();
                authManager = new AuthManager();
                console.log('‚úÖ Managers inicializados');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        });

        function checkConfiguration() {
            const statusDiv = document.getElementById('config-status');
            let html = '';

            // Verificar CONFIG
            if (typeof window.CONFIG !== 'undefined') {
                html += '<p>‚úÖ <strong>CONFIG:</strong> Carregado</p>';
                
                if (window.CONFIG.API && window.CONFIG.API.BASE_URL) {
                    html += `<p>‚úÖ <strong>URL Google Apps Script:</strong> ${window.CONFIG.API.BASE_URL}</p>`;
                    
                    if (window.CONFIG.API.BASE_URL.includes('script.google.com')) {
                        html += '<p>‚úÖ <strong>Modo:</strong> Produ√ß√£o (Google Apps Script)</p>';
                    } else {
                        html += '<p>‚ö†Ô∏è <strong>Modo:</strong> Local/Desenvolvimento</p>';
                    }
                } else {
                    html += '<p>‚ùå <strong>URL:</strong> N√£o configurada</p>';
                }
            } else {
                html += '<p>‚ùå <strong>CONFIG:</strong> N√£o carregado</p>';
            }

            // Verificar Helpers
            if (typeof window.Helpers !== 'undefined') {
                html += '<p>‚úÖ <strong>Helpers:</strong> Carregado</p>';
            } else {
                html += '<p>‚ùå <strong>Helpers:</strong> N√£o carregado</p>';
            }

            // Verificar FlowExtensions
            if (typeof FlowExtensions !== 'undefined') {
                html += '<p>‚úÖ <strong>FlowExtensions:</strong> Dispon√≠vel</p>';
            } else {
                html += '<p>‚ùå <strong>FlowExtensions:</strong> N√£o encontrado</p>';
            }

            statusDiv.innerHTML = html;
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<p>üîÑ Testando conex√£o...</p>';

            try {
                if (!flowManager) {
                    throw new Error('FlowManager n√£o inicializado');
                }

                console.log('üß™ Iniciando teste de conex√£o...');
                
                const result = await flowManager.sendToScript({
                    action: 'ping',
                    data: { message: 'Teste de conex√£o' }
                });

                console.log('üì° Resposta recebida:', result);

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <p><strong>‚úÖ Conex√£o Bem-sucedida!</strong></p>
                            <p>Resposta: ${JSON.stringify(result, null, 2)}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <p><strong>‚ùå Conex√£o Falhou</strong></p>
                            <p>Erro: ${result.error || 'Erro desconhecido'}</p>
                            <p>Dados: ${JSON.stringify(result, null, 2)}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro no teste:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <p><strong>‚ùå Erro na Execu√ß√£o</strong></p>
                        <p>Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            resultDiv.innerHTML = '<p>üîÑ Testando login...</p>';

            try {
                console.log('üß™ Testando login:', email);
                
                const result = await flowManager.validateUser(email, password);
                console.log('üîê Resposta do login:', result);

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <p><strong>‚úÖ Login Bem-sucedido!</strong></p>
                            <p>Usu√°rio: ${result.data?.nome || 'N/A'}</p>
                            <p>Cargo: ${result.data?.cargo || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <p><strong>‚ùå Login Falhou</strong></p>
                            <p>Erro: ${result.error || result.message || 'Credenciais inv√°lidas'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <p><strong>‚ùå Erro na Execu√ß√£o</strong></p>
                        <p>Erro: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function testCreateTicket() {
            const resultDiv = document.getElementById('ticket-result');
            resultDiv.innerHTML = '<p>üîÑ Criando chamado de teste...</p>';

            try {
                const ticketData = {
                    nome: 'Jo√£o da Silva (TESTE)',
                    telefone: '11999999999',
                    email: 'joao@teste.com',
                    categoria: 'documentos',
                    demanda: 'cpf',
                    descricao: 'Chamado de teste via Google Apps Script',
                    igreja: 'Igreja Central',
                    regiao: 'Norte',
                    prioridade: 'media'
                };

                console.log('üß™ Criando chamado:', ticketData);
                
                const result = await flowManager.createTicket(ticketData);
                console.log('üìã Resposta do chamado:', result);

                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <p><strong>‚úÖ Chamado Criado!</strong></p>
                            <p>ID: ${result.data?.id || 'N/A'}</p>
                            <p>Status: ${result.data?.status || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-error">
                            <p><strong>‚ùå Erro na Cria√ß√£o</strong></p>
                            <p>Erro: ${result.error || result.message || 'Erro desconhecido'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro na cria√ß√£o:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <p><strong>‚ùå Erro na Execu√ß√£o</strong></p>
                        <p>Erro: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
